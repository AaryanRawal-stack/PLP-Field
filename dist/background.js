(()=>{"use strict";function r(){for(var r,e=arguments.length,t=new Array(e),o=0;o<e;o++)t[o]=arguments[o];(r=console).log.apply(r,["[DEBUG]"].concat(t))}function e(){for(var r,e=arguments.length,t=new Array(e),o=0;o<e;o++)t[o]=arguments[o];(r=console).warn.apply(r,["[WARN]"].concat(t))}function t(){for(var r,e=arguments.length,t=new Array(e),o=0;o<e;o++)t[o]=arguments[o];(r=console).error.apply(r,["[ERROR]"].concat(t))}chrome.runtime.onMessage.addListener((function(o,a,n){r("📩 Message received in background script:",o);var c={startExtraction:function(o,a){var n;r("🚀 Handling 'startExtraction' action. Request:",o);var c=null===(n=o.payload)||void 0===n?void 0:n.account;if(!c)return e("⚠️ No target account provided."),a({code:400,data:{error:"No account provided"}}),!0;var s="https://www.instagram.com/".concat(c,"/");return chrome.storage.local.set({currentTargetAccount:c},(function(){if(chrome.runtime.lastError)return t("❌ Error saving targetAccount:",chrome.runtime.lastError),a({code:500,data:{error:"Storage error"}}),!0;r("✅ Target account saved:",c),chrome.tabs.create({url:s},(function(e){if(chrome.runtime.lastError)return t("❌ Tab creation failed:",chrome.runtime.lastError),a({code:500,data:{error:"Tab creation failed"}}),!0;var o=e.id;r("✅ New tab created. Waiting for content script:",e),chrome.storage.local.set({instagramTabId:o},(function(){if(chrome.runtime.lastError)return t("❌ Error saving instagramTabId:",chrome.runtime.lastError),a({code:500,data:{error:"Tab ID storage error"}}),!0;r("✅ instagramTabId stored:",o)})),chrome.runtime.openOptionsPage(),r("✅ Options page opened automatically."),a({code:200,data:{status:"Navigation initiated"}})}))})),!0},contentScriptLoaded:function(e,o,a){return r("📩 Content script reported readiness. Checking pause state..."),chrome.storage.local.get(["instagramTabId","extractionPaused"],(function(e){var o=e.instagramTabId,n=e.extractionPaused;return o?n?(r("Extraction is currently paused. Not sending startExtraction."),void a({code:200,data:{status:"extraction is paused"}})):(r("✅ Sending 'startExtraction' command to tab:",o),void chrome.tabs.sendMessage(o,{action:"startExtraction"},(function(e){r("📩 'startExtraction' response from content script:",e),a({code:200,data:{status:"Extraction started"}})}))):(t("❌ No stored instagramTabId found. Cannot send 'startExtraction'."),a({code:500,data:{error:"No tab ID found"}}),!0)})),!0},pauseExtraction:function(e,o,a){return r("⏸️ Handling 'pauseExtraction' action."),chrome.storage.local.set({extractionPaused:!0},(function(){if(chrome.runtime.lastError)return t("❌ Failed to pause extraction:",chrome.runtime.lastError),void a({code:500,data:{error:chrome.runtime.lastError.message}});r("✅ Extraction paused."),a({code:200,data:{status:"paused"}})})),!0},resumeExtraction:function(e,o,a){return r("▶️ Handling 'resumeExtraction' action."),chrome.storage.local.set({extractionPaused:!1},(function(){if(chrome.runtime.lastError)return t("❌ Failed to resume extraction:",chrome.runtime.lastError),void a({code:500,data:{error:chrome.runtime.lastError.message}});r("✅ Extraction resumed."),a({code:200,data:{status:"resumed"}})})),!0},exportCSV:function(e,o){return r("📤 Handling 'exportCSV' action..."),chrome.storage.local.get(["exportedFollowers"],(function(e){if(chrome.runtime.lastError)return t("❌ Failed to retrieve followers:",chrome.runtime.lastError),void o({code:500,data:{error:chrome.runtime.lastError.message}});var a=e.exportedFollowers||[];if(r("📦 exportCSV - Retrieved followers from storage:",a.length),!a.length)return t("⚠️ No followers to export."),void o({code:400,data:{error:"No followers to export."}});var n="Username,Account Link,Public Status\n";a.forEach((function(r){var e=r.isPrivate?"private":"public";n+="".concat(r.username,",https://www.instagram.com/").concat(r.username,"/,").concat(e,"\n")}));try{var c=new Blob([n],{type:"text/csv"}),s=new FileReader;s.onloadend=function(){var e=s.result;chrome.downloads.download({url:e,filename:"followers.csv",saveAs:!0},(function(e){if(chrome.runtime.lastError)return t("❌ Download failed:",chrome.runtime.lastError),void o({code:500,data:{error:chrome.runtime.lastError.message}});r("✅ CSV file download initiated. Download ID:",e),o({code:200,data:{export_status:"success",downloadId:e}})}))},s.readAsDataURL(c)}catch(r){t("❌ Failed to create CSV file:",r),o({code:500,data:{error:r.message}})}})),!0},export_followers:function(o,a){r("📩 Received 'export_followers' message from content script.");var n=o.data||[];return r("🔍 Extracted Followers Received:",n),n.length?(chrome.storage.local.get(["exportedFollowers"],(function(e){r("📦 Retrieved existing followers from storage:",e.exportedFollowers);var o=e.exportedFollowers||[],c=new Map;o.forEach((function(r){return c.set(r.username,r)})),n.forEach((function(r){return c.set(r.username,r)}));var s=Array.from(c.values());chrome.storage.local.set({exportedFollowers:s},(function(){chrome.runtime.lastError?(t("❌ Failed to store followers:",chrome.runtime.lastError),a({code:500,data:{error:chrome.runtime.lastError}})):(r("✅ Successfully stored followers. Total:",s.length),a({code:200,data:{export_status:"success",count:s.length}}))}))})),!0):(e("⚠️ No followers received from content script."),a({code:400,data:{error:"No followers received"}}),!0)},updateProgress:function(e,t){return r("🔄 Handling 'updateProgress' action:",e.data),t({code:200,data:{status:"progress updated"}}),r("✅ 'updateProgress' action handled."),!0}};return c[o.action]?c[o.action](o,a,n):(e("⚠️ Unhandled message action:",o.action),n({code:200,data:{}}),!0)}))})();